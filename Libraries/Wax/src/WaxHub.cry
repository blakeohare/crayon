import Json;

namespace Wax {

    class WaxHub {
        @private
        constructor() { }

        static field _instance = null;

        static function getActiveHub() {
            if (WaxHub._instance == null) {
                WaxHub._instance = new WaxHub();
            }
            return WaxHub._instance;
        }

        function awaitSendRequest(serviceId, payload) {
            serializedData = WaxHub._encodePayload(payload);
            errOut = [null];
            result = $$$('waxAwaitSend', serviceId, serializedData, errOut);
            WaxHub._errHandle(errOut[0]);
            return Json.parseJson(result);
        }

        function sendRequest(serviceId, payload, cb = null, isRecurring = false) {
            serializedData = WaxHub._encodePayload(payload);
            err = $$$('waxSend', serviceId + '', serializedData, isRecurring == true, (err, rawData) => {
                WaxHub._errHandle([err]);
                res = Json.parseJson(rawData);
                if (cb != null) {
                    cb(res);
                }
            });
            WaxHub._errHandle(err);
        }

        static function _encodePayload(payload) {
            if (Core.typeof(payload) != Type.DICTIONARY) throw new InvalidArgumentException("Payload must be a JSON-serializable dictionary.");
            return Json.serializeJson(payload); // TODO: catch error here if there's a bad nested type
        }

        function createSubscription(serviceId, payload, recurringCb) {
            this.sendRequest(serviceId, payload, recurringCb, true);
        }

        static function _errHandle(err) {
            if (err == null) return;
            throw new Exception(err);
        }
    }
}
